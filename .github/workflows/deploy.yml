name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'Deploy Backend (Fly.io)'
        required: false
        type: boolean
        default: true
      deploy_frontend:
        description: 'Deploy Frontend (Cloudflare Pages)'
        required: false
        type: boolean
        default: true

env:
  NODE_VERSION: '20'
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
  # ===========================================
  # Pre-deployment checks
  # ===========================================
  check:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    outputs:
      deploy_backend: ${{ steps.changes.outputs.backend }}
      deploy_frontend: ${{ steps.changes.outputs.frontend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changes
        id: changes
        run: |
          # For workflow_dispatch, use inputs
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "backend=${{ inputs.deploy_backend }}" >> $GITHUB_OUTPUT
            echo "frontend=${{ inputs.deploy_frontend }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          # For push events, detect changes
          BACKEND_CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '^services/lead-service/' | wc -l)
          FRONTEND_CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '^(apps/web/|src/|middleware\.ts|package\.json)' | wc -l)

          if [ "$BACKEND_CHANGED" -gt 0 ]; then
            echo "backend=true" >> $GITHUB_OUTPUT
          else
            echo "backend=false" >> $GITHUB_OUTPUT
          fi

          if [ "$FRONTEND_CHANGED" -gt 0 ]; then
            echo "frontend=true" >> $GITHUB_OUTPUT
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
          fi

      - name: Summary
        run: |
          echo "## Deployment Plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Backend (Fly.io): ${{ steps.changes.outputs.backend }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend (Cloudflare): ${{ steps.changes.outputs.frontend }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # Backend Deployment (Fly.io)
  # ===========================================
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: check
    if: needs.check.outputs.deploy_backend == 'true'
    defaults:
      run:
        working-directory: services/lead-service

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        run: flyctl deploy --remote-only --wait-timeout 300

      - name: Health Check
        run: |
          sleep 30
          for i in {1..10}; do
            if curl -sf https://zuclubit-lead-service.fly.dev/health; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 10s..."
            sleep 10
          done
          echo "Health check failed after 10 attempts"
          exit 1

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Backend Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **App**: zuclubit-lead-service" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://zuclubit-lead-service.fly.dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Health**: https://zuclubit-lead-service.fly.dev/health" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # Frontend Deployment (Cloudflare Pages)
  # ===========================================
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: check
    if: needs.check.outputs.deploy_frontend == 'true'
    defaults:
      run:
        working-directory: apps/web

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install root dependencies
        working-directory: .
        run: npm ci

      - name: Install web dependencies
        run: npm ci

      - name: Build for Cloudflare Pages
        run: npm run build:cf
        env:
          NODE_ENV: production
          NEXT_PUBLIC_API_URL: https://zuclubit-lead-service.fly.dev/api/v1
          NEXT_PUBLIC_SUPABASE_URL: https://fngdlxipgrkpbutiqjhw.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: apps/web
          command: pages deploy .open-next/assets --project-name=ventazo --branch=main --commit-dirty=true

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Frontend Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Project**: ventazo" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://ventazo.pages.dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Custom Domain**: https://crm.zuclubit.com" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # Post-deployment notification
  # ===========================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()
    steps:
      - name: Deployment Status
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.deploy-backend.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.deploy-frontend.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### URLs" >> $GITHUB_STEP_SUMMARY
          echo "- Backend API: https://zuclubit-lead-service.fly.dev" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: https://ventazo.pages.dev" >> $GITHUB_STEP_SUMMARY
          echo "- Custom Domain: https://crm.zuclubit.com" >> $GITHUB_STEP_SUMMARY
